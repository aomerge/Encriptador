/**
 * Public key for party A.
 * @type {any}
 */
let publicKeyA, privateKeyA, publicKeyB, privateKeyB, sharedSecret;

/**
 * Generates two sets of key pairs for ECDH encryption.
 * @returns {Promise<void>} A promise that resolves when the key pairs are generated.
 */
async function generateKeyPairs() {
  const keyPairA = await window.crypto.subtle.generateKey(
    {
      name: "ECDH",
      namedCurve: "P-256",
    },
    true,
    ["deriveKey"]
  );
  publicKeyA = keyPairA.publicKey;
  privateKeyA = keyPairA.privateKey;

  const keyPairB = await window.crypto.subtle.generateKey(
    {
      name: "ECDH",
      namedCurve: "P-256",
    },
    true,
    ["deriveKey"]
  );
  publicKeyB = keyPairB.publicKey;
  privateKeyB = keyPairB.privateKey;

  sharedSecret = await window.crypto.subtle.deriveKey(
    {
      name: "ECDH",
      public: publicKeyB,
    },
    privateKeyA,
    { name: "AES-GCM", length: 256 },
    false,
    ["encrypt", "decrypt"]
  );
  // add class to the button
  const button = document.getElementById("generateKey");
  button.classList.add("AniNone");
}

/**
 * Encrypts the given text using AES-GCM encryption algorithm.
 * @param {string} text - The text to be encrypted.
 * @returns {Promise<string>} - The encrypted text.
 */
async function encrypt(text) {  
  const encoded = new TextEncoder().encode(text);
  const iv = window.crypto.getRandomValues(new Uint8Array(12));
  const encrypted = await window.crypto.subtle.encrypt(
    {
      name: "AES-GCM",
      iv: iv,
    },
    sharedSecret,
    encoded
  );

  /**
   * Encrypted text generated by the encryption process.
   * @type {string}
   */
  const encryptedText =
    iv.join(",") +
    "," +
    btoa(String.fromCharCode(...new Uint8Array(encrypted)));
  return encryptedText;
}

/**
 * Decrypts the given text using AES-GCM encryption.
 * 
 * @param {string} text - The encrypted text to be decrypted.
 * @returns {Promise<string>} - A promise that resolves to the decrypted text.
 */
async function decrypt(text) {
  const encryptedData = text.split(",");
  const iv = new Uint8Array(encryptedData.slice(0, 12).map(Number));
  const encryptedText = encryptedData[12];
  const encryptedBuffer = new Uint8Array(
    atob(encryptedText)
      .split("")
      .map((char) => char.charCodeAt(0))
  );
  const decrypted = await window.crypto.subtle.decrypt(
    {
      name: "AES-GCM",
      iv: iv,
    },
    sharedSecret,
    encryptedBuffer
  );
  const decryptedText = new TextDecoder().decode(decrypted);
  return decryptedText;
}
